<!doctype html>
<html lang="en" style="height: 100vh; margin: 0; padding: 0">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>HK Paths - Cesium 3D</title>

        <!-- Cesium from CDN -->
        <script src="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Cesium.js"></script>
        <link
            href="https://cesium.com/downloads/cesiumjs/releases/1.114/Build/Cesium/Widgets/widgets.css"
            rel="stylesheet"
        />

        <style>
            #cesiumContainer {
                width: 100%;
                height: 100%;
                margin: 0;
                padding: 0;
                overflow: hidden;
            }

            .header {
                padding: 10px;
                background-color: rgba(255, 255, 255, 0.8);
                z-index: 1000;
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
            }
        </style>
    </head>
    <body style="height: 100vh; margin: 0; padding: 0">
        <div class="header">
            <h1>HK Paths - 3D Flight Tracks</h1>
            <button id="toggleAltitudeColors" style="margin-left: 20px; padding: 5px 10px; cursor: pointer;">
                Use Palette Colors
            </button>
        </div>
        <div id="cesiumContainer"></div>

        <script type="module">
            import { jsonFiles } from "./fileIndex.js";

            Cesium.Ion.defaultAccessToken =
                "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiIzMzQ1ZDBjMi0yMmZhLTRhYmItYjFmNC05ODVkMGNjNGNlNjQiLCJpZCI6MzA4MTg2LCJpYXQiOjE3NDg3NzgwMzB9.o-M5-iKk1e_omJhzGdLeygfCt1t-rhH92wNNzBlNIS4";

            // An array of visually distinct colors that work well against blue/green backgrounds
            const COLOR_PALETTE = [
                [255, 87, 51],   // Bright Red-Orange
                [255, 195, 0],   // Golden Yellow
                [255, 64, 129],  // Hot Pink
                [138, 43, 226],  // Purple
                [255, 140, 0],   // Dark Orange
                [0, 230, 118],   // Bright Green
                [29, 233, 182],  // Turquoise
                [213, 0, 249],   // Magenta
                [255, 23, 68],   // Red
                [240, 98, 146],  // Pink
                [124, 77, 255],  // Purple-Blue
                [57, 73, 171],   // Indigo
                [0, 188, 212],   // Cyan
                [255, 152, 0],   // Orange
                [174, 234, 0],   // Lime
                [255, 87, 34],   // Deep Orange
                [121, 85, 72],   // Brown
                [158, 158, 158], // Grey
                [3, 169, 244],   // Light Blue
                [0, 150, 136],   // Teal
            ];
            
            // Keep track of which colors we've used to avoid repeats until necessary
            let colorIndex = 0;
            let useAltitudeColors = true;
            
            // Get the next color from the palette
            function getNextColorFromPalette() {
                const rgb = COLOR_PALETTE[colorIndex];
                colorIndex = (colorIndex + 1) % COLOR_PALETTE.length;
                return new Cesium.Color(rgb[0]/255, rgb[1]/255, rgb[2]/255, 1.0);
            }
            
            // Create a color based on altitude using a scale from 0 to 15,000 meters
            function getColorByAltitude(altitude) {
                // Normalize altitude between 0 and 1 (using 0 to 15,000 meters scale)
                const normalizedAlt = Math.min(Math.max(altitude / 15000, 0), 1);
                
                // Color gradient from blue (low) to red (high)
                if (normalizedAlt < 0.2) {
                    return new Cesium.Color(0, 0, 1, 1); // Blue (0-3,000m)
                } else if (normalizedAlt < 0.4) {
                    return new Cesium.Color(0, 1, 1, 1); // Cyan (3,000-6,000m)
                } else if (normalizedAlt < 0.6) {
                    return new Cesium.Color(0, 1, 0, 1); // Green (6,000-9,000m)
                } else if (normalizedAlt < 0.8) {
                    return new Cesium.Color(1, 1, 0, 1); // Yellow (9,000-12,000m)
                } else {
                    return new Cesium.Color(1, 0, 0, 1); // Red (12,000-15,000m+)
                }
            }
            
            // Initialize the Cesium Viewer
            const viewer = new Cesium.Viewer("cesiumContainer", {
                timeline: false,
                animation: false,
                shouldAnimate: true,
                terrainProvider: await Cesium.createWorldTerrainAsync(),
            });

            // Set the initial camera position to Hong Kong
            viewer.camera.setView({
                destination: Cesium.Cartesian3.fromDegrees(
                    114.1095,
                    22.3964,
                    50000,
                ), // Hong Kong coordinates with altitude
                orientation: {
                    heading: 0.0,
                    pitch: -Cesium.Math.PI_OVER_TWO / 2, // Look down at 45 degrees
                    roll: 0.0,
                },
            });
            // Function to draw flight paths in 3D
            async function drawFlightPath(jsonFilename) {
                try {
                    const response = await fetch(`./data/${jsonFilename}`);
                    const data = await response.json();

                    // Extract track data
                    const tracks = data[0].tracks;

                    if (!tracks || tracks.length === 0) {
                        console.warn(`No tracks found in ${jsonFilename}`);
                        return null;
                    }

                    // Create points array for Cesium polyline
                    const positions = [];

                    for (let i = 0; i < tracks.length; i++) {
                        const track = tracks[i];
                        // Add position with altitude (in meters)
                        positions.push(
                            Cesium.Cartesian3.fromDegrees(
                                track.lon,
                                track.lat,
                                track.alt,
                            ),
                        );
                    }

                    if (positions.length < 2) {
                        console.warn(
                            `Not enough valid positions in ${jsonFilename}`,
                        );
                        return null;
                    }

                    // Determine coloring approach based on mode
                    let entity;
                    if (useAltitudeColors) {
                        // Variable coloring based on altitude - create segment for each point pair
                        const altitudes = tracks.map(track => track.alt);
                        const minAlt = Math.min(...altitudes);
                        const maxAlt = Math.max(...altitudes);
                        
                        // Create segments with individual colors based on altitude at each point
                        const segmentEntities = [];
                        for (let i = 0; i < positions.length - 1; i++) {
                            const color = getColorByAltitude(tracks[i].alt);
                            const segmentEntity = viewer.entities.add({
                                polyline: {
                                    positions: [positions[i], positions[i+1]],
                                    width: 3,
                                    material: color,
                                    clampToGround: false,
                                }
                            });
                            segmentEntities.push(segmentEntity);
                        }
                        
                        // Add a reference entity for the full path (for name and tracking purposes)
                        entity = viewer.entities.add({
                            name: `Flight ${data[0].fr24_id || jsonFilename}`,
                            polyline: {
                                positions: positions,
                                width: 1,
                                material: new Cesium.PolylineOutlineMaterialProperty({
                                    color: Cesium.Color.WHITE.withAlpha(0.2),
                                    outlineWidth: 0,
                                    outlineColor: Cesium.Color.BLACK
                                }),
                                clampToGround: false,
                            },
                            properties: {
                                minAltitude: minAlt,
                                maxAltitude: maxAlt,
                                segmentEntities: segmentEntities
                            }
                        });
                        
                        console.log("Using variable altitude colors for altitude range:", 
                            minAlt.toFixed(0), "to", maxAlt.toFixed(0), "meters (scale: 0-15000m)");
                    } else {
                        // Use the next color from our curated palette
                        const color = getNextColorFromPalette();
                        console.log("Using palette color", color);
                        
                        // Add the flight path as a polyline with single color
                        entity = viewer.entities.add({
                            name: `Flight ${data[0].fr24_id || jsonFilename}`,
                            polyline: {
                                positions: positions,
                                width: 2,
                                material: color,
                                clampToGround: false,
                            },
                        });
                    }

                    // Add a point entity at the start of the path
                    const startColor = useAltitudeColors ? getColorByAltitude(tracks[0].alt) : color;
                    viewer.entities.add({
                        position: positions[0],
                        point: {
                            pixelSize: 8,
                            color: startColor,
                            outlineColor: Cesium.Color.WHITE,
                            outlineWidth: 2,
                        },
                        description: useAltitudeColors ? 
                            `Starting altitude: ${tracks[0].alt.toFixed(0)} meters` : 
                            `Flight ${data[0].fr24_id || jsonFilename}`,
                    });
                    
                    return entity;
                } catch (error) {
                    console.error(`Error processing ${jsonFilename}:`, error);
                    return null;
                }
            }

            // Load and visualize all flight paths
            async function loadAllFlightPaths() {
                console.log("Loading flight paths, altitude coloring:", useAltitudeColors);
                
                // Clear existing entities
                viewer.entities.removeAll();
                
                // Reset the color index
                colorIndex = 0;
                
                // Disable camera controls during loading
                const controller = viewer.scene.screenSpaceCameraController;
                controller.enableRotate = false;
                controller.enableTranslate = false;
                controller.enableZoom = false;
                controller.enableTilt = false;
                controller.enableLook = false;

                try {
                    // Process files in batches
                    const batchSize = 5; // Reduced batch size for more reliable processing
                    let loadedCount = 0;
                    
                    for (let i = 0; i < jsonFiles.length; i += batchSize) {
                        const batch = jsonFiles.slice(i, i + batchSize);
                        console.log(`Processing batch ${i/batchSize + 1}/${Math.ceil(jsonFiles.length/batchSize)}`);
                        
                        // Process each file sequentially within the batch for more reliability
                        const results = [];
                        for (const file of batch) {
                            const entity = await drawFlightPath(file);
                            results.push(entity);
                        }
                        
                        // Count successful entities
                        loadedCount += results.filter(entity => entity !== null).length;
                        
                        // Allow UI to update
                        await new Promise(resolve => setTimeout(resolve, 20));
                    }
                    
                    console.log(`Successfully loaded ${loadedCount} flight paths`);
                } catch (error) {
                    console.error("Error loading flight paths:", error);
                } finally {
                    // Re-enable camera controls
                    controller.enableRotate = true;
                    controller.enableTranslate = true;
                    controller.enableZoom = true;
                    controller.enableTilt = true;
                    controller.enableLook = true;
                }
            }

            // Add a legend for altitude colors
            function addAltitudeLegend() {
                const legend = document.createElement('div');
                legend.id = 'altitude-legend';
                legend.style.position = 'absolute';
                legend.style.right = '10px';
                legend.style.top = '50px';
                legend.style.backgroundColor = 'rgba(255, 255, 255, 0.8)';
                legend.style.padding = '10px';
                legend.style.borderRadius = '5px';
                legend.style.display = useAltitudeColors ? 'block' : 'none';
                
                legend.innerHTML = `
                    <div style="font-weight: bold; margin-bottom: 5px;">Altitude Scale (meters)</div>
                    <div style="display: flex; align-items: center; margin: 2px 0;">
                        <div style="width: 20px; height: 20px; background: rgb(255,0,0); margin-right: 10px;"></div>
                        <span>12,000 - 15,000+</span>
                    </div>
                    <div style="display: flex; align-items: center; margin: 2px 0;">
                        <div style="width: 20px; height: 20px; background: rgb(255,255,0); margin-right: 10px;"></div>
                        <span>9,000 - 12,000</span>
                    </div>
                    <div style="display: flex; align-items: center; margin: 2px 0;">
                        <div style="width: 20px; height: 20px; background: rgb(0,255,0); margin-right: 10px;"></div>
                        <span>6,000 - 9,000</span>
                    </div>
                    <div style="display: flex; align-items: center; margin: 2px 0;">
                        <div style="width: 20px; height: 20px; background: rgb(0,255,255); margin-right: 10px;"></div>
                        <span>3,000 - 6,000</span>
                    </div>
                    <div style="display: flex; align-items: center; margin: 2px 0;">
                        <div style="width: 20px; height: 20px; background: rgb(0,0,255); margin-right: 10px;"></div>
                        <span>0 - 3,000</span>
                    </div>
                `;
                
                document.body.appendChild(legend);
                return legend;
            }
            
            // Create the legend
            const altitudeLegend = addAltitudeLegend();
            
            // Toggle altitude-based coloring
            document.getElementById('toggleAltitudeColors').addEventListener('click', function() {
                // Toggle the coloring mode
                useAltitudeColors = !useAltitudeColors;
                
                // Update button text
                this.textContent = useAltitudeColors ? 'Use Palette Colors' : 'Use Variable Altitude Colors (0-15000m)';
                
                // Toggle the legend display
                altitudeLegend.style.display = useAltitudeColors ? 'block' : 'none';
                
                console.log("Color mode changed:", useAltitudeColors ? "altitude-based" : "palette-based");
                
                // Clear existing paths and redraw with new coloring
                viewer.entities.removeAll();
                
                // Reset color index when switching back to palette mode
                if (!useAltitudeColors) {
                    colorIndex = 0;
                }
                
                // Give the UI a moment to update before redrawing
                setTimeout(() => {
                    loadAllFlightPaths();
                }, 100);
            });
            
            // Start loading flight paths
            loadAllFlightPaths();

            // Add some helpful controls for the user
            viewer.homeButton.viewModel.command.beforeExecute.addEventListener(
                function (e) {
                    e.cancel = true;
                    viewer.camera.flyTo({
                        destination: Cesium.Cartesian3.fromDegrees(
                            114.1095,
                            22.3964,
                            50000,
                        ),
                        orientation: {
                            heading: 0.0,
                            pitch: -Cesium.Math.PI_OVER_TWO / 2,
                            roll: 0.0,
                        },
                    });
                },
            );
        </script>
    </body>
</html>
